
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inbox · bezrealit.eu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/assets/css/style.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="/">
      <img src="/assets/img/logo.svg" alt="" class="me-2" height="28"><strong>bezrealit.eu</strong>
    </a>
  </div>
</nav>
<main class="container py-4" id="inbox">
  <div class="row g-4">
    <aside class="col-lg-4">
      <div class="card">
        <div class="card-header">Konverzace</div>
        <div class="card-body thread-list" id="threads"></div>
      </div>
    </aside>
    <section class="col-lg-8">
      <div class="card h-100">
        <div class="card-header" id="chatHeader">Vyberte konverzaci</div>
        <div class="card-body" id="messages" style="height:420px; overflow:auto;"></div>
        <div class="card-footer">
          <form id="msgForm" class="d-flex gap-2 align-items-center">
            <label class="btn btn-light m-0">
              <i class="bi bi-paperclip"></i>
              <input type="file" id="msgFiles" accept="image/*" multiple style="display:none;">
            </label>
            <input class="form-control" placeholder="Napište zprávu…" id="msgInput">
            <button class="btn btn-primary" type="submit">Odeslat</button>
          </form>
        </div>
      </div>
    </section>
  </div>
</main>
<script type="module">
import { auth, onAuthStateChanged } from '/assets/js/firebase.js';
import { listenThreads, listenMessages, sendMessage } from '/assets/js/modules/chat.js';

const threadsEl = document.getElementById('threads');
const messagesEl = document.getElementById('messages');
const chatHeader = document.getElementById('chatHeader');
const form = document.getElementById('msgForm');
const input = document.getElementById('msgInput');
let currentUser=null, unsubMsgs=null, activeThread=null;

import { uploadChatImages, sendMessageWithImages, markSeen, getThumbUrl } from '/assets/js/modules/chat.js';

const filesInput = document.getElementById('msgFiles');
let cooldown = false; // simple client rate-limit (~2s)

async function renderMessagesAsync(msgs){
  const blocks = [];
  for(const m of msgs){
    const parts = [];
    if(m.images && m.images.length){
      for(const im of m.images){ const tu = await getThumbUrl(im); parts.push(`<div><img src='${tu}' class='img-fluid rounded mt-1' style='max-width:240px'></div>`); }
    }
    const rr = (m.seenBy && m.seenBy.length>1) ? `<span class='text-muted small ms-2'>✓✓</span>` : '';
    blocks.push(`<div class='message ${m.fromUid===currentUser.uid?'me':'other'} mb-2'>${m.text||''} ${rr} ${parts.join('')}</div>`);
  }
  return blocks.join('');
}


function renderMessages(msgs){
  messagesEl.innerHTML = msgs.map(m=>{
    
    const rr = (m.seenBy && m.seenBy.length>1) ? `<span class='text-muted small ms-2'>✓✓</span>` : '';
    return `<div class='message ${m.fromUid===currentUser.uid?'me':'other'} mb-2'>${m.text||''} ${rr} ${imgs}</div>`;
  }).join('');
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function canSend(){ return !cooldown; }
function armCooldown(){ cooldown = true; setTimeout(()=>cooldown=false, 2000); }


onAuthStateChanged(auth, (u)=>{
  if(!u){ window.location.href = '/login.html?lang=cs'; return; }
  currentUser = u;
  listenThreads(u.uid, (items)=>{
    threadsEl.innerHTML = items.map(t=>`<div class='thread mb-2 ${activeThread===t.id?'active':''}' data-id='${t.id}'>
      <div class='fw-semibold'>${t.listingTitle||'Thread'}</div>
      <div class='text-muted small'>aktualizováno</div>
    </div>`).join('') || '<div class="text-muted">Žádné zprávy</div>';
  });
});

threadsEl.addEventListener('click', (e)=>{
  const th = e.target.closest('.thread'); if(!th) return;
  activeThread = th.getAttribute('data-id');
  chatHeader.textContent = 'Konverzace';
  messagesEl.innerHTML = '';
  if(unsubMsgs) unsubMsgs();
  unsubMsgs = listenMessages(activeThread, async (msgs)=>{
    messagesEl.innerHTML = await renderMessagesAsync(msgs);
    if(currentUser) await markSeen(activeThread, currentUser.uid);
  });
});

form.addEventListener('submit', async (e)=>{
  e.preventDefault(); if(!currentUser || !activeThread) return;
  if(!canSend()) return; armCooldown();
  const text = input.value.trim(); input.value='';
  let imageUrls = [];
  const files = filesInput?.files;
  if(files && files.length){ imageUrls = await uploadChatImages(activeThread, currentUser.uid, files); filesInput.value=''; }
  if(text || imageUrls.length){ const callable = httpsCallable(functions, "sendMessageProxy");
  await callable({ threadId: activeThread, text, images: imageUrls }); }
});
</script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
